name: Performance Regression

on:
  pull_request:
    branches: [main]
    paths:
      - "src/**"
      - "benchmarks/**"

jobs:
  benchmark:
    name: Performance Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20.x
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build package
        run: npm run build

      - name: Run benchmarks (PR)
        run: npm run bench > pr-results.txt

      - name: Checkout main branch
        run: git checkout main

      - name: Install dependencies (main)
        run: npm ci

      - name: Build package (main)
        run: npm run build

      - name: Run benchmarks (main)
        run: npm run bench > main-results.txt

      - name: Compare performance
        id: compare
        run: |
          echo "## ðŸ“Š Performance Comparison" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Main Branch Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          head -50 main-results.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### PR Results" >> $GITHUB_STEP_SUMMARY  
          echo '```' >> $GITHUB_STEP_SUMMARY
          head -50 pr-results.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ **Note**: Significant performance changes (>20% regression) should be investigated." >> $GITHUB_STEP_SUMMARY

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: |
            pr-results.txt
            main-results.txt
